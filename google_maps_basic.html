<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レストラン推薦アプリ - マップ表示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .controls {
            background-color: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
        }
        
        .control-group input, .control-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .map-container {
            position: relative;
            height: calc(100vh - 140px);
            width: 100%;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .status {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            z-index: 1000;
        }
        
        .status.loading {
            background-color: #f39c12;
            color: white;
        }
        
        .status.success {
            background-color: #27ae60;
            color: white;
        }
        
        .status.error {
            background-color: #e74c3c;
            color: white;
        }
        
        .debug-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            max-width: 300px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-panel h3 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .debug-panel p {
            margin-bottom: 0.25rem;
            color: #555;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🍽️ レストラン推薦マップ</h1>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="location-input">場所を検索</label>
            <input type="text" id="location-input" placeholder="例: 東京駅, 渋谷区など">
        </div>
        
        <div class="control-group">
            <label for="radius-select">検索範囲</label>
            <select id="radius-select">
                <option value="500">500m</option>
                <option value="1000" selected>1km</option>
                <option value="2000">2km</option>
                <option value="5000">5km</option>
            </select>
        </div>
        
        <button class="btn" id="search-btn">🔍 検索</button>
        <button class="btn" id="current-location-btn">📍 現在地</button>
        <button class="btn" id="debug-toggle-btn">🐛 デバッグ</button>
    </div>
    
    <div class="map-container">
        <div class="status" id="status">マップを読み込み中...</div>
        
        <div id="map"></div>
        
        <div class="debug-panel" id="debug-panel">
            <h3>デバッグ情報</h3>
            <p><strong>座標:</strong> <span id="debug-coords">-</span></p>
            <p><strong>ズームレベル:</strong> <span id="debug-zoom">-</span></p>
            <p><strong>最後の検索:</strong> <span id="debug-last-search">-</span></p>
            <p><strong>API状態:</strong> <span id="debug-api-status">-</span></p>
        </div>
    </div>

    <script>
        // グローバル変数
        let map;
        let geocoder;
        let currentPosition = null;
        let markers = [];
        
        // デバッグ用のログ関数
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            
            // デバッグパネルの更新
            updateDebugPanel();
        }
        
        // ステータス表示の更新
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            
            debugLog(`Status: ${message}`, type);
            
            // 3秒後に非表示
            setTimeout(() => {
                if (type !== 'error') {
                    statusEl.style.display = 'none';
                }
            }, 3000);
        }
        
        // デバッグパネルの更新
        function updateDebugPanel() {
            if (!map) return;
            
            const center = map.getCenter();
            document.getElementById('debug-coords').textContent = 
                `${center.lat().toFixed(6)}, ${center.lng().toFixed(6)}`;
            document.getElementById('debug-zoom').textContent = map.getZoom();
            document.getElementById('debug-api-status').textContent = 
                typeof google !== 'undefined' ? 'OK' : 'エラー';
        }
        
        // マップの初期化
        function initMap() {
            try {
                debugLog('マップ初期化開始');
                
                // デフォルト位置（東京駅）
                const defaultLocation = { lat: 35.6812, lng: 139.7671 };
                
                // マップの作成
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: defaultLocation,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true,
                    zoomControl: true,
                });
                
                // Geocoder の初期化
                geocoder = new google.maps.Geocoder();
                
                // マップイベントリスナー
                map.addListener('center_changed', updateDebugPanel);
                map.addListener('zoom_changed', updateDebugPanel);
                
                updateStatus('マップの読み込み完了！', 'success');
                debugLog('マップ初期化完了');
                
                // 現在地の取得を試行
                getCurrentLocation();
                
            } catch (error) {
                debugLog(`マップ初期化エラー: ${error.message}`, 'error');
                updateStatus('マップの読み込みに失敗しました', 'error');
            }
        }
        
        // 現在地の取得
        function getCurrentLocation() {
            if (navigator.geolocation) {
                debugLog('現在地取得開始');
                updateStatus('現在地を取得中...', 'loading');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        debugLog(`現在地取得成功: ${currentPosition.lat}, ${currentPosition.lng}`);
                        updateStatus('現在地を取得しました', 'success');
                        
                        // マップを現在地に移動
                        map.setCenter(currentPosition);
                        
                        // 現在地マーカーを追加
                        addCurrentLocationMarker(currentPosition);
                    },
                    (error) => {
                        debugLog(`現在地取得エラー: ${error.message}`, 'error');
                        updateStatus('現在地の取得に失敗しました', 'error');
                    }
                );
            } else {
                debugLog('Geolocation API がサポートされていません', 'error');
                updateStatus('現在地機能がサポートされていません', 'error');
            }
        }
        
        // 現在地マーカーを追加
        function addCurrentLocationMarker(position) {
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: "現在地",
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="8" fill="#3498db" stroke="white" stroke-width="2"/>
                            <circle cx="12" cy="12" r="3" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24),
                    anchor: new google.maps.Point(12, 12)
                }
            });
            
            markers.push(marker);
            debugLog('現在地マーカーを追加');
        }
        
        // マーカーをクリア
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            debugLog('マーカーをクリア');
        }
        
        // 場所を検索
        function searchLocation() {
            const locationInput = document.getElementById('location-input').value;
            if (!locationInput.trim()) {
                updateStatus('検索する場所を入力してください', 'error');
                return;
            }
            
            debugLog(`場所検索開始: ${locationInput}`);
            updateStatus('場所を検索中...', 'loading');
            
            geocoder.geocode({ address: locationInput }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    map.setZoom(15);
                    
                    // 検索結果マーカーを追加
                    const marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: locationInput,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#e74c3c" stroke="white" stroke-width="1"/>
                                    <circle cx="12" cy="9" r="2.5" fill="white"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(24, 24),
                            anchor: new google.maps.Point(12, 24)
                        }
                    });
                    
                    markers.push(marker);
                    
                    debugLog(`場所検索成功: ${location.lat()}, ${location.lng()}`);
                    updateStatus(`「${locationInput}」を見つけました`, 'success');
                    
                    document.getElementById('debug-last-search').textContent = locationInput;
                } else {
                    debugLog(`場所検索エラー: ${status}`, 'error');
                    updateStatus('場所が見つかりませんでした', 'error');
                }
            });
        }
        
        // イベントリスナーの設定
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM読み込み完了');
            
            // 検索ボタン
            document.getElementById('search-btn').addEventListener('click', searchLocation);
            
            // 現在地ボタン
            document.getElementById('current-location-btn').addEventListener('click', getCurrentLocation);
            
            // デバッグパネル切り替え
            document.getElementById('debug-toggle-btn').addEventListener('click', function() {
                const panel = document.getElementById('debug-panel');
                panel.classList.toggle('show');
                debugLog('デバッグパネル切り替え');
            });
            
            // Enterキーで検索
            document.getElementById('location-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            debugLog('イベントリスナー設定完了');
        });
        
        // マップ読み込みエラーのハンドリング
        window.gm_authFailure = function() {
            debugLog('Google Maps API認証エラー', 'error');
            updateStatus('Google Maps APIキーが無効です', 'error');
        };
    </script>
    
    <!-- Google Maps API を読み込み -->
    <!-- 注意: YOUR_API_KEY を実際のAPIキーに置き換えてください -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=places&language=ja">
    </script>
</body>
</html>